В прошлый раз говорили о моделях и основная - **FCAPS**. С помощью неё осуществляется управление по процессам.
Сегодня обсуждаем первую букву - F (faults). **F - это управление отказами.** 

В современных системах очень редко бывает так, что что-то развалилось и не работает в принципе. Оно будет работать, но работать **медленно**. Поэтому в современных системах буква **F (faults)** и **P (performance)** совпадают.

Делать **Performance** сложно, но важно, потому что нужно управлять быстро. 
Вся модель FCAPS описана на сайтах ISO и ITU и является платной.

Вся группа F это 12 задач ==(назвала не все)==:
- **Сбор данных (мониторинг)**
- **Фильтрация ошибок** 
	Для того чтобы реагировать только на существенные ошибки, а не на все подряд. 
- **Маршрутизация**
	Нам нужно куда-то отправить все, что произошло
- **Исправление ошибок**
- **Диагностика**
- **Фиксирование результата**

Проблема в том **"Как это делать?"** Для решения этих задач необходимо понять, что такое система, в которой нет отказов и как мы будем это оценивать. Тут мы переходим к **метрикам**.

## Метрики
Система не может работать семь дней в неделю 24 часа в сутки. Мы всегда должны планировать простой системы. Вопрос в том - сколько система может не работать. Если это дата центр высокого класса, то он может не работать 29 минут в год.
Метрики записываются в **SLA** в различных отделах, в которых я буду говорить, что **для данной** системы является безотказной работой системы.

Есть два типа метрик: **бизнес метрики** и **технические метрики**.

### Бизнес метрики
Пользователей не интересуют технические метрики, так как они не понимают всего этого. Например, "падение утилизации канала" ничего не говорит простому пользователю. Ему важны **бизнес метрики** и они основные!

**MTTR (mean time to repair)** – время на восстановление системы и **оно зависит от денег**. Среднее время восстановления где-то  может быть даже сутки, а где-то не может превышать 3 минуты. Это все вопросы денег. Так как, чтобы восстанавливать систему быстрее, нужны другие средства, которые стоят больших денег. 

Но чтобы восстановиться, нужно еще найти, что случилось. И такая метрика называется **uptime**.

**Uptime** – интегральная метрика, которая включает в себя время на диагностику, время на восстановление, время на поиск и исправление возникшей ошибки.
**И это тоже вопрос денег**, потому что если нужно, чтобы я находил ошибку за одно время, то должно быть соответствующее оснащение сетевой бригады, а это стоит денег.

### Технические метрики
Мы профессионалы и поэтому должны иметь еще и некие технические метрики.

**MTBF (mean time between failures)** – метрика, которая есть у любой аппаратуры, но ее нет у софта. Это метрика производителя вычислительной техники, которую нужно смотреть в документации производителя (если у одного нет - беру у другого).

Примерные сроки годности:
- Кабель – 40 лет
- Комплексная техника 5 / 15 / 25 лет

Live time guaranty – пожизненная гарантия

## SYSLOG
Для того, чтобы оценивать метрики, нам нужен инструментарий. Он может быть **software** или **hardware**.

Софтом ничего поймать нельзя! Это будет работать только в случае, если с **hardware** частью все хорошо. Сюда можно отнести Zabbix, Nagios, HP OpenView. И это больше подходит для сбора статистики (мониторинга).

Похожий инструментарий есть в составе ОС, но он может помочь сделать только статистику.

На кафедре стоит **syslog server**, для сбора всех логов (всей статистики, которую дает операционная система).

> Syslog – дрянь полная

Syslog должен быть отдельным сервером в системе
![[Pasted image 20231120160030.png|600]]

Syslog по протоколу syslog будет собирать информацию о событиях, которые произошли. У каждой ОС есть лог.
Логирование это серьезная проблема во всех системах, и это нужно уметь делать. (Необходимо обрабатывать каждый код возврата программы.)

- Везде должен быть загружен драйвер протокола Syslog
- На всех ОС должен поддерживаться этот протокол

Но никто не обещал его поддерживать, поэтому это не всегда и не везде работает.

Есть другие средства и они **hardware**. Таким средствам мы будем верить, если производитель серьезный. Диагностику ошибок нельзя доверить тому, кто сделал этот софт. Производители средств диагностики должны быть независимыми. 
Эти производители работают на разных уровнях модели OSI. Эта модель подразумевает, что разные средства выполняют разные функции по диагностике ошибок.

Уровень OSI | Средство диагностики 
------------ | ------------
1 layer | Кабельные тестеры (Производители: Wavetek, Fluke, Arbor)
2-4 layer | Протокольные анализаторы (Производители: Fluke, Cisco) (Продукты: NetFlow)
5-7 layer | Симуляторы трафика, Анализаторы трафика, Потоковые анализаторы

Очень любит компанию  Fluke, сейчас часть перепродана Arbor

Основная проблема в диагностике ошибок - это наша голова. Потому что важно понимать, как искать ошибки.

## Модель поиска ошибок

Описано в учебниках по ОС, Fluke, IBM

> Пользователь - это диагноз

1. **Убедиться, что проблема действительно есть**
	
2. **Убедиться, что система целостна**
	Кабели должны быть подключены, оборудование на месте, лампочки сетевых адаптеров должны гореть зеленым.
	- зеленый - все хорошо
	- желтый - режим ожидания
	- красный/оранжевый - ошибка
	
3. **Делаем бэкапы системы**
	Есть три способа восстановления системы: бэкап, бэкап, бэкап! 
	Важно делать бэкап всей системы, а не какой-то ее кусок. 
	Начинаем делать бэкапы с системных параметров (volume (том) system). В каждой ОС от 300 параметров. Если их потерять, то будем ужасно долго это все восстанавливать. В большой системе будет около 80 000 параметров. Такой бэкап делается при помощи специальных утилит операционной системы **диск в диск**.
	
4. **Делаем перезагрузку**
	- Холодный старт - отключаем питание
	- Горячий старт - перезагружаем софт
	Горячий старт довольно безопасный, но может помочь только, если сломалось что-то не очень серьезное.
	Холодный старт делать опасно т.к. заново происходить перераспределение памяти, заново будут загружаться драйверы. Холодный старт необходимо делать для всех систем, а не для одной какой-то. Если сломалось что-то серьезное, например, отказал диск, то можно уже не запуститься.
	Если ты новичок, то лучше не делать холодный старт.
	
5. **При загрузке упростить работу**
	Нужно определить, что загружаем, а что нам сейчас можно и нужно не загружать
	Если не работает одна подсистема, например, какой-нибудь 1с, то не надо загружать вместе с ней что-то, что на нее не влияет. Потому что будет еще хуже.
	
6. **Проверяю права и привилегии**
	Тут интересует защита от несанкционированного доступа. Потому что прикладные программисты могут написать что-нибудь, например, на SQL и сделать команду `grant`.
	- право - право доступа куда-то
	- привилегия - право дать право
	Где проверять права и привилегии - сказать нельзя, т.к. системы большие и нужно разбираться в каждой отдельно. Но по крайней мере **в логинах операционных систем** проверить нужно точно.
	
 7. **Убеждаюсь в том, что версии софта такие же, как и до изменений**
	 Нужно фиксировать версии во время их изменения. Посмотреть версии софта можно в логах, потому что если продукт написан правильно, то первым логом при записи будет что-то типа 'В такое-то время запускаю такой-то продукт такой-то версия'. 
	 - Версия не должна быть последней, потому что ее еще не успели нормально отладить и найти все ошибки в ней. 
	 - Так же не стоит пользоваться версией продукта, когда у него в принципе еще мало версий. Например, не нужно пользоваться версией 1.1, а нужно подождать версии, к примеру, 5.28. Тут проблема та же - не успели найти все ошибки.
	 
 8. **Только сейчас будем смотреть логи**
	 Логи нужно смотреть на `File server` и `DB server`. Логи Nagios или SYSLOG не заслуживают доверия. Хорошо будет посмотреть логи fluke. На основе этих логов уже принимать какие-то действия.
	 
 9. **Выдвигаем гипотезы**
	Их необходимо ранжировать по степени вероятности ошибок.
	- Кабельные системы витой пары, коаксиал - это все старое, поэтому если в системе они, то 80% ошибок будет тут. Если система современная, а значит оптоволоконная, то там все работает, и ошибка где-то в другом месте.
	- Следующее по вероятности - ошибки в прикладных продуктах, потому что тираж прикладного софта всегда меньше, чем тираж системного, а значит и отлажен он хуже, чем системный.
	- Далее идут системные ошибки, но у них процент меньше, так как их тираж большой.
	- Аппаратная часть. Тут так же дело в тираже.
	- В конце проверяем оптоволокно, но тут уже вероятность почти нулевая.
	После того, как мы поняли в каком месте ошибка, мы начинаем проверять по **нисходящей последовательности** или **восходящей последовательности**. То есть либо от роутера до сервера, либо от сервера до роутера.
	
	**Проверять нужно по одной гипотезе за раз!**
	
 10. **Проверяем гипотезы**
	 Проверять нужно гипотезы в определенном порядке. Сначала необходимо проверить те гипотезы, которые **быстрее всего** проверить.
	 
 11. **После нахождения ошибки фиксируем в журнале ошибок**
	 После того, как ошибка была найдена, ее нужно зафиксировать. Причем лучше вести бумажный журнал от руки, потому что если не работает все, то электронные записи ошибок тоже работать не будут. 


## Стратегии поиска ошибок
Стратегия поиска ошибок может быть **проактивной** или **пассивной**.
### Пассивная
Когда что-то случилось, тогда идем искать
### Проактивная
До возникновения ошибок предпринимаем какие-то действия.
1. **В SLA записываем время активного поиска ошибки**
	Если указали, что ошибки ищем 7 дней в неделю 24 часа в сутки, то и ошибки искать нужно 7 дней в неделю 24 часа в сутки. Поэтому записываем, например, что какой-нибудь 1с работает с 9 утра до 6 вечера, и ошибки мы будем искать в это же время.
	
2. **Создаем в настройках софта специальные триггеры**
	Например, если total time (время работы программы) увеличилось до значения n, то пора кричать, что это ошибка.
	
3. **Настроить параметры автоматической перезагрузки**
	Настроить автоматическую перезагрузку на некий софт. Например, так умеет делать Nagios.
	Но так делать никогда не надо, потому что если проблемы серьезные, то потом в этом не разберетесь.
	
4. **Нужны специальные регламентные работы**
	При этих регламентных работах мы можем установить некие параметры и сказать, что, например, по кабельным системам будем делать регламентные работы раз в год


## Фильтрация ошибок
Важный вопрос состоит в том, что считать ошибкой, а что нет.
На эту тему есть масса теорий, но верить нужно тем, кто это делает с 1949 года. Такая информация, как правило, закрытая и платная. Она есть во всяких учебных центрах.
Еще можно искать в таких штуках, как **white papers**.

**White papers** - это исследовательские документы различных компаний, в которых они иногда "проговариваются". Их можно получить бесплатно.

Есть два класса ошибок, которые мы всегда должны учитывать. Все мы работаем по стеку протоколов TCP/IP и все мы работаем в Ethernet. В любом дата-центре будет Ethernet и Fiber channel.

## Одноминутная проверка Ethernet
У Fluke есть методика, согласно которой **Ethernet должен проверяться за 1 минуту**. 
В нее входит:
1. **Пропускная способность канала**
	С помощью технической аппаратуры мы должны удостовериться, что пропускная способность канала упала не более чем на 1%.
	
2. **Процент утилизации**
	Есть процент средней утилизации (использование ресурса в единицу времени) канала. Он должен ровняться 40% в среднем и 60% в моменты пиковой нагрузки. Если процент больше, то это может приводить к ошибкам и крикам "медленно" и "не работает".
	
3. **Процент коллизий**
	Количество коллизий не должно превышать 5% от общего количества пакетов (фреймов, если речь идет об Ethernet).
	
>[!info] Коллизии 
>Все передавали и все испортилось, потому что возник конфликт по использованию среды передачи. Дальше начинаются крики об Ethernet без коллизий. **Такого не бывает!** Коллизии будут всегда, вопрос лишь в том, сколько их будет. Если топология **шина** - то коллизии будет бесконечными, если **звезда**, то коллизии будут на портах.
	
4. **Процент Broadcast-запросов** 
	У нас все системы постоянно опрашивают друг-друга. Я когда ищу сервер СУБД, рассылаю всем крик души с воплем "К какому серверу мне подключаться? Дайте имя." И подобных запросов много.
	Так вот количество Broadcast-запросов **не должно** быть больше 10% от общего количества пакетов (пакетов, потому что это уже до 7 уровня).

## Если такая проверка не прошла
1. **Проблемы hardware**
	Такие проблемы связаны с тем, что неправильно работают сетевые адаптеры. Неправильно может работать коммутатор (никто не сказал, что он сломался; он просто работает неправильно).
	
2. **Поздние коллизии**
	Это происходит, когда коммутатор находит коллизию слишком поздно. Тогда возникают ненужные коллизии. Потому что он рассматривает на за первые 64 байта, а когда уже фрейм прошел, и только теперь он понял, что сейчас будет коллизия.
	Это зависит от того как сделан hard и написан soft.
	В таком случае можно требовать у производителя замены, но это сложно и долго.
	
3. **Короткие фреймы**
	Фреймы могут быть меньше 64 байт. В таком случае должны быть **pad**-ы, чтобы добить до 64 байт.
	Если, например, фрейм 48 байт, то нужно добивать до 64. Иначе не успеем поймать коллизию.
	
4. **Развалилась кабельная система**
	Если мы получаем у всех фреймов неправильные контрольные суммы, то у нас развалилась кабельная система.
	
5. **RUNT ошибки**
	Это ошибка, когда фрейм меньше даже 48 байтов. Тут уже случилось что-то совсем трагическое, и нужно разбираться с аппаратурой.

6. **Ghost ошибки**
	Есть такие фреймы, которые длиной не менее 72 байт. И они могут с правильными или неправильными контрольными суммами.
	
	В определенном районе было все то медленно, то нормально. И было непонятно, почему так, потому что ошибка плавает. Эти фреймы иногда имеют правильную контрольную сумму, а иногда неправильную. Такая ошибка возникает, когда рядом с вами заработал кто-то, кто генерирует высокочастотные импульсы. В том случае в соседнем доме кто-то включал мотор-генератор, потому что света не было. И из-за этого происходили интерференции в среду передачи компании из-за которых то все работало нормально, то медленно. ^f38ea2


## Ошибки TCP/IP
Ошибка так же должна быть найдена за 1 минуту. 

**Ошибок TCP/IP не должно быть вообще!**

1. **Проверяется адресация**
	Мы должны иметь список устройств, которые работают как хосты, то есть имеют ip-адрес. Все устройства из этого списка должны иметь адрес, и если его нет, то все не будет работать.
2. **Проверка настроек**
	По списку устройств посмотреть не активировались ли коммутаторы, где функции маршрутизации отключены или наоборот включены (например включил NAT, и там в таблицах неправильно нарисовал, из-за этого будут ошибки)
3. **Проверить функции**
	Провериxть не отключилось ли что-то в функциях ОС, коммутаторов, шлюзов
4. **Проверка устройств по списку**
	Проверить по списку мосты, коммутаторы, роутер (он работает как router или уже нет, бывают Brouter). Проверить по списку тех, кто должен работать как сервер DNS (DNS - не обязательный его нет в составе ОС, это продукт оператора связи, который предоставляет доступ ко всей системе) а вот DHCP -обязательный
	Проверить список серверов DHCP

В небольшой системе до 800 портов адресация - статическая. В таком случае IP-адрес должен быть записан в специальном конфигурационном файле на диске чтобы было быстро. 
Если в системе более 800 портов, будет стоять DHCP. 
Если бездисковые станции то тоже DHCP


[[Беленькая]], [[Управление и администрирование информационных систем]], [[Лекции]]